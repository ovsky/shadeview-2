"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_1=require("vscode"),fs=require("fs"),path=require("path");class Utilities{static isInTempFolder(t){return-1!=t.toLowerCase().indexOf(path.sep+"temp"+path.sep)}static readFile(t){try{return fs.existsSync(t)?fs.readFileSync(t,"utf-8"):void 0}catch(t){return}}static getFileMTimeInMS(t){try{return fs.statSync(t).mtimeMs}catch(t){return}}static getLocalPackages(t){let e=[];if(!fs.existsSync(t))return e;t=path.join(t,"Packages","manifest.json");if(!fs.existsSync(t))return e;var t=this.readFile(t),a=JSON.parse(t);for(const s in a.dependencies){var i=a.dependencies[s];-1!==i.indexOf("file:")&&e.push({packageName:s,content:i.substring(5)})}return e}static getPackagesPath(t){var e=[];for(const a of[path.join(t,"Packages"),path.join(t,"Library","PackageCache")])fs.existsSync(a)&&e.push(...fs.readdirSync(a).filter(t=>fs.statSync(path.resolve(a,t)).isDirectory));return e}static join(...t){return path.join(...t)}static isFolder(t){return fs.statSync(t).isDirectory()}static getFileName(t){return path.basename(t)}static getFiles(t){return fs.existsSync(t)?fs.readdirSync(t):[]}static getProjectRootFolder(t){if(this.ProjectRootMap.has(t))return this.ProjectRootMap.get(t);var e=this.getPossibleIndex(t.fsPath);if(-1!=e){e=t.fsPath.substring(0,e+1);return this.ProjectRootMap.set(t,e),e}this.ProjectRootMap.set(t,void 0)}static getPossibleIndex(t){var e=-1;for(const n of[path.sep+"assets"+path.sep,path.sep+"packages"+path.sep,path.sep+"library"+path.sep+"packagecache"+path.sep])if(-1!=(e=t.toLocaleLowerCase().indexOf(n)))break;var a,i;if(-1==e)for(var s=path.dirname(t);s;){if(r=s,i=a=void 0,a=path.join(r,"assets"),i=path.join(r,"library"),-1!=(e=fs.existsSync(a)&&fs.existsSync(i)?r.length:-1))return e;var r=path.dirname(s);if(r==s)break;s=r}return e}static getUnityApplicationPath(a){if(this.AppplicationRootMap.has(a))return this.AppplicationRootMap.get(a);var t=this.getProjectRootFolder(a);if(t){var i=path.resolve(t,"Assembly-CSharp.csproj");if(fs.existsSync(i)){let t=fs.readFileSync(i).toString();let e=t.match(/<HintPath>(.+)Managed.(UnityEngine.)?UnityEngine.dll<\/HintPath>/m);if(e&&1<e.length)return this.AppplicationRootMap.set(a,e[1].toString()),e[1].toString()}var s=path.resolve(t,"Library");for(const o of this.getFiles(s))if(-1!==o.indexOf("shadercompiler-")){var r=path.resolve(s,o);let t=fs.readFileSync(r).toString(),e=t.split(/['\r\n]/);var n="Base path:";if(n.toLowerCase()===e[0].toLowerCase().trim()){r=e[1].trim();return this.AppplicationRootMap.set(a,r),r}if(e[0].toLowerCase().startsWith(n.toLowerCase())){n=e[0].substring(n.length).trim();return this.AppplicationRootMap.set(a,n),n}}this.AppplicationRootMap.set(a,void 0)}else this.AppplicationRootMap.set(a,void 0)}static getPath(t,e,a=void 0){var i=t.fsPath;let s=path.resolve(i,"..",e);if(fs.existsSync(s))return vscode_1.Uri.file(s);if(a&&(s=path.resolve(a,e),fs.existsSync(s)))return vscode_1.Uri.file(s);t=this.getUnityApplicationPath(t);if(t&&(s=path.resolve(t,"CGIncludes",e),fs.existsSync(s)))return vscode_1.Uri.file(s);t=this.getPossibleIndex(i);if(-1!=t){var r=i.substring(0,t+1);if(e.toLowerCase().startsWith("packages")){var n=this.GetPackageNameInInclude(e);if(!n)return vscode_1.Uri.file(s);var o,c=e.substring(10+n.length);for(const h of this.getPackagesPath(r)){var p=h.replace(/@[0-9a-zA-Z_\.-]+/,"");if(-1!=e.toLowerCase().indexOf(p.toLowerCase())&&(s=path.join(r,"Packages",h,c),fs.existsSync(s)||(s=path.join(r,"Library","PackageCache",h,c)),fs.existsSync(s)))return vscode_1.Uri.file(s)}for(o of this.getLocalPackages(r))if(o.packageName.toLowerCase()==n.toLowerCase())return vscode_1.Uri.file(path.join(r,"packages",o.content,c))}else s=path.resolve(r,e);if(fs.existsSync(s))return vscode_1.Uri.file(s)}}static translatePackagePath(e,t){var a=[path.resolve(e.fsPath,"..",t)],i=this.getProjectRootFolder(e);if(i){var s=t.toLowerCase();if(s.startsWith("packages")){e=this.getLocalPackages(i);if("packages/"==s){let t=[path.join(i,"Packages"),path.join(i,"Library","PackageCache")];for(const p of e)t.push("local:"+p.packageName);return t}var r=this.GetPackageNameInInclude(t);if(!r)return a;var n,o=t.substring(10+r.length);for(const h of this.getPackagesPath(i)){var c=h.replace(/@[0-9a-zA-Z_\.-]+/,"");if(-1!=s.indexOf(c.toLowerCase())){c=path.join(i,"Packages",h,o);return[c=!fs.existsSync(c)?path.join(i,"Library","PackageCache",h,o):c]}}for(n of e)if(n.packageName.toLowerCase()==r.toLowerCase())return[path.join(i,"packages",n.content,o)];return a}return s.startsWith("assets")?[path.join(i,t)]:a}return a}static GetPackageNameInInclude(t){var e,a=t.substr(9),t=a.replace(/\\/g,"/").indexOf("/");return e=-1!=t?a.substr(0,t):e}static getMethodNameIfInMethodRange(s,a){if(!(a<0||a>s.length)&&s){let e=1,i=-1;for(let t=a;0<t;t--){var r=s.charAt(t);if(!Utilities.IsWhiteSpace(r)&&(")"===r?e++:"("===r&&e--,0==e)){i=t;break}}if(-1!==i){let e=s.substring(0,i).trim(),a=-1;for(let t=i-1;0<t;t--){var n=e.charAt(t);if(Utilities.IsWhiteSpace(n)||"="===n||"("===n||","===n||";"===n){a=t;break}}if(-1!==a)return e.substring(a+1,i)}}}static getFirstNonSpaceCharInvInText(e,a){if(!(a<0||a>e.length)&&e)for(let t=a;0<t;t--){var i=e.charAt(t);if(!Utilities.IsWhiteSpace(i))return i}}static getLevelCount(t){let e=vscode_1.workspace.getConfiguration();var a=e.get("editor.insertSpaces"),i=e.get("editor.tabSize");let s=t;a&&(s=s.replace(/\t/gm,Utilities.getRepeatText(" ",i)));let r=0;for(let t=0;t<s.length;t++){var n=s[t];if(!Utilities.IsWhiteSpace(n))break;r+="\t"==n?4:1}return Math.ceil(r/i)}static getFirstNonSpaceTexInv(e,a){var i=e.lineAt(a.line).text;for(let t=a.character-1;0<t;t--){var s=i.charAt(t);if(!Utilities.IsWhiteSpace(s))return e.getText(e.getWordRangeAtPosition(new vscode_1.Position(a.line,t)))}}static getFirstNonSpaceIndex(e){for(let t=0;t<e.length;t++)if(!Utilities.IsWhiteSpace(e[t]))return t;return-1}static getSecondNonSpaceTexInv(e,a){var i=e.lineAt(a.line).text;let s=1;for(let t=a.character-1;0<t;t--){var r=i.charAt(t);if(!Utilities.IsWhiteSpace(r)){if(!(0<s))return e.getText(e.getWordRangeAtPosition(new vscode_1.Position(a.line,t)));r=e.getWordRangeAtPosition(new vscode_1.Position(a.line,t));r&&(t=r.start.character,s--)}}}static IsWhiteSpace(t){return" "===t||"\t"===t||"\r"===t||"\n"===t}static removeEmptyEntry(t){let e=[];return t&&t.forEach(t=>{t.trim()&&e.push(t)}),e}static GetFullRangeOfDocument(t){return t.validateRange(new vscode_1.Range(0,0,Number.MAX_VALUE,Number.MAX_VALUE))}static IsCommentLine(t){let e=t.trim();return!!(e.startsWith("//")||e.startsWith("/*")||e.endsWith("*/"))}static getRepeatText(e,a){let i="";if(!e||a<0)return i;for(let t=0;t<a;t++)i+=e;return i}}Utilities.ProjectRootMap=new Map,Utilities.AppplicationRootMap=new Map,exports.default=Utilities;